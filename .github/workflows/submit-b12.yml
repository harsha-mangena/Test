name: Submit to B12

on:
  workflow_dispatch: {}

jobs:
  submit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Submit to B12
        shell: bash
        env:
          NAME: Vamsi Sai Ranga Mangina
          EMAIL: sairanga.mangina@gmail.com
          RESUME_LINK: https://drive.google.com/file/d/15zZvTzBCZl8mRLojCS7W9Xe92frXp4Dx/view?usp=sharing
          REPOSITORY_LINK: ${{ github.server_url }}/${{ github.repository }}
          ACTION_RUN_LINK: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SIGNING_SECRET: hello-there-from-b12
        run: |
          set -euo pipefail
          
          # Generate ISO 8601 timestamp
          export TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%S.000Z')
          
          echo "üìù Building payload..."
          echo "Action Run: $ACTION_RUN_LINK"
          
          # Create JSON payload (alphabetically sorted, compact)
          PAYLOAD=$(python3 - <<'PY'
import json, os
payload = {
    "action_run_link": os.environ.get("ACTION_RUN_LINK"),
    "email": os.environ.get("EMAIL"),
    "name": os.environ.get("NAME"),
    "repository_link": os.environ.get("REPOSITORY_LINK"),
    "resume_link": os.environ.get("RESUME_LINK"),
    "timestamp": os.environ.get("TIMESTAMP"),
}
print(json.dumps(payload, separators=(",", ":"), sort_keys=True))
PY
          )
          
          echo "Payload: $PAYLOAD"
          
          # Generate HMAC-SHA256 signature
          SIGNATURE="sha256=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$SIGNING_SECRET" -hex | cut -d' ' -f2)"
          
          echo "üîê Signature: $SIGNATURE"
          
          # Submit to B12
          echo "üöÄ Submitting to B12..."
          RESPONSE=$(curl -s -X POST https://b12.io/apply/submission \
            -H "Content-Type: application/json" \
            -H "X-Signature-256: $SIGNATURE" \
            -d "$PAYLOAD")
          
          echo "Response: $RESPONSE"
          
          # Extract receipt
          export RESPONSE
          RECEIPT=$(python3 - <<'PY'
import json, os
resp = os.environ.get("RESPONSE", "")
try:
    data = json.loads(resp)
    print(data.get("receipt") or "ERROR")
except Exception:
    print("ERROR")
PY
          )
          
          echo ""
          if [ "$RECEIPT" != "ERROR" ] && [ -n "$RECEIPT" ]; then
            echo "================================================"
            echo "‚úÖ SUBMISSION SUCCESSFUL!"
            echo "================================================"
            echo "üìã RECEIPT: $RECEIPT"
            echo "================================================"
            echo ""
            echo "Copy and paste this receipt into the B12 confirmation field!"
          else
            echo "================================================"
            echo "‚ùå SUBMISSION FAILED"
            echo "================================================"
            echo "Response: $RESPONSE"
            echo "================================================"
            exit 1
          fi
